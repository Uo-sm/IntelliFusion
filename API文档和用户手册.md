### **API文档**
#### **1. 接口概述**
- **接口名称**：IntelliFusion AI聊天助手API
- **功能描述**：集成多模态大语言模型，支持文本/图像交互、工具调用（文件读取/天气查询/网络搜索）、RAG知识库检索, 情感分析等功能。
- **技术栈**：OpenAI API（通过代理`https://api.siliconflow.cn/v1`）、自定义工具调用逻辑。


#### **2. 核心接口列表**
| **接口名称**       | **请求方式** | **路径**               | **主要功能**                                                                 |
|--------------------|--------------|------------------------|-----------------------------------------------------------------------------|
| 模型对话接口       | POST         | `/v1/chat/completions`  | 基于对话历史生成AI响应，支持流式输出和多模态输入（图像Base64编码）。         |
| 文件读取工具接口   | POST         | `/v1/tools/file/read`  | 读取本地文档（PDF/Word/TXT）并返回内容摘要。                                 |
| 天气查询工具接口   | GET          | `/v1/tools/weather`    | 根据地理位置获取实时天气信息。                                               |
| 网络搜索工具接口   | GET          | `/v1/tools/search`     | 基于关键词执行网络搜索并返回结果摘要。                                       |
| RAG知识库检索接口  | POST         | `/v1/rag/retrieve`     | 根据查询词从知识库中检索相关上下文。                                         |


#### **3. 接口详情：模型对话接口**
##### **3.1 请求参数**
```python
{
    "model": "Pro/deepseek-ai/DeepSeek-R1",  # 模型枚举值，支持DeepSeek-R1、Wan2.1-T2V等
    "messages": [  # 对话历史，格式与OpenAI API兼容
        {"role": "user", "content": "你好，帮我分析文本情感"},
        {"role": "assistant", "content": "请提供具体文本"}
    ],
    "temperature": 0.7,  # 温度参数，范围0-2
    "stream": true,  # 是否启用流式响应
    "image": ""  # 多模态输入（仅Qwen/QVQ-72B-Preview模型支持，Base64编码）
}
```

##### **3.2 输入校验规则**
- **JSON Schema校验**：遵循`INPUT_SCHEMA`（见代码`IntelliFusion.py`），必填字段为`question`。
- **多模态限制**：仅`Qwen/QVQ-72B-Preview`模型支持图像输入，非多模态模型需清空`image`字段。

##### **3.3 响应参数**
```python
{
    "status": "success",  # 状态：success/error/loading/tool_required
    "content": "AI响应内容",
    "timestamp": 1691234567,  # 时间戳
    "model": "Pro/deepseek-ai/DeepSeek-R1",
    "rag_context": "检索到的上下文",  # RAG启用时返回
    "tool_used": "none"  # 工具调用类型：none/file/weather/search
}
```

##### **3.4 流式响应处理**
- **格式**：遵循OpenAI流式响应规范，每个chunk以`data: {\"choices\":[{\"delta\":{\"content\":\"文本片段\"}}]}\n\n`格式返回。
- **代码实现**：见`ChatApp._get_llm_response`方法，通过`self.client.chat.completions.create(stream=True)`启用流式输出。


#### **4. 工具接口详情**
##### **4.1 文件读取接口**
- **请求参数**：`{"file_path": "文档路径"}`
- **响应示例**：
```python
{
    "tool": "file",
    "result": "文件内容摘要（限制3000字）",
    "success": true
}
```


##### **4.2 天气查询接口**
- **请求参数**：`{"location": "北京市"}`
- **响应示例**：
```python
{
    "tool": "weather",
    "result": "当前北京市的天气状况：晴。温度：25°C，湿度：40%，风速：2m/s。",
    "success": true
}
```

##### **4.3 网络搜索接口**
- **请求参数**：`{"query": "人工智能发展趋势", "num_results": 5}`
- **响应示例**：
```python
{
    "tool": "search",
    "result": "搜索结果:\n标题: 2025人工智能趋势...\n链接: https://example.com\n摘要: 报告指出AI将在医疗...\n\n标题: 大语言模型未来方向...",
    "success": true
}
```


#### **5. 异常处理**
- **API调用失败**：返回`{"status": "error", "content": "API错误详情"}`，并触发重试机制（见`ChatApp._process_user_question`）。
- **输入格式错误**：返回`400 Bad Request`，附带JSON Schema校验错误信息（如`"输入格式错误: question字段不能为空"`）。
- **工具调用失败**：如文件不存在时返回`{"tool": "file", "result": "文件不存在", "success": false}`。


### **用户手册**
#### **1. 系统简介**
- **功能亮点**：
  - 支持多模态交互（文本+图像输入），集成DeepSeek、Qwen等大语言模型。
  - 内置文件读取、天气查询、网络搜索3种工具，支持自定义工具配置。
  - 基于RAG架构的知识库管理，支持文档分块与语义检索。
  - 情感引擎动态调整对话语气（兴奋/满足/压力状态）。

- **技术架构**：
  ```
  ┌───────────────┐     ┌─────────────┐     ┌─────────────┐
  │  用户界面层   │─────→│  交互逻辑层  │─────→│  模型调用层  │
  │ (GUI/Tkinter) │     │ (EmotionalEngine)│     │ (OpenAI API)│
  └───────────────┘     └─────────────┘     └─────────────┘
              │                             │
              ▼                             ▼
    ┌──────────────────────┐     ┌──────────────────┐
    │     工具调用模块     │     │     RAG模块      │
    │ (文件/天气/搜索)    │     │ (知识库/检索)    │
    └──────────────────────┘     └──────────────────┘
  ```


#### **2. 快速开始**
##### **2.1 环境配置**
- **依赖安装**：
  ```bash
  pip install -r requirements.txt 

  conda env create -f environment.yml
  ```
- **API密钥配置**：
  1. 在项目根目录创建`.env`文件，填入：
     ```
     OPENAI_API_KEY=你的OpenAI密钥
     WEATHER_API_KEY=OpenWeatherMap密钥
     SEARCH_API_KEY=SerpAPI密钥
     ```
  2. 或通过工具配置界面（菜单栏→工具→配置）填写密钥。

##### **2.2 启动与界面说明**
- **启动命令**：`python IntelliFusion.py`
- **界面模块**：
  - **顶部栏**：工具开关（文件/天气/搜索）、情感模式启用、模型选择、Temperature调节、图像上传。
  - **中部**：记忆状态、记忆文件列表、聊天记录显示区、RAG上下文显示区。
  - **底部**：输入框、发送按钮、模型状态显示。
  - **菜单栏**：工具配置、记忆管理（保存/加载）、知识库管理（导入/清空）。


#### **3. 核心功能使用指南**
##### **3.1 文本对话**
1. 在输入框中输入问题（如“解释大语言模型的工作原理”、“解释以下代码: def add(a, b): return a + b”）。
2. 调整`Temperature`参数（0.7→保守回答，1.2→创意回答）。
3. 点击“发送”按钮，AI将流式返回响应（打字机效果）。

##### **3.2 多模态交互（图像输入）**
1. 选择模型`Qwen/QVQ-72B-Preview`。
2. 点击“选择图片”上传本地图像（支持JPG/PNG，≤5MB）。
3. 输入问题（如“分析这张图片中的场景”），AI将结合图像内容回答。

##### **3.3 工具调用**
- **文件读取**：
  1. 确保“文件读取”开关开启（工具框架→勾选“文件读取”）。
  2. 输入包含文件绝对路径的问题（如“读取F:\data.pdf的内容，并回答……问题”）。
  3. AI将自动解析文件并结合内容回答。

- **天气查询**：
  输入格式示例：“北京今天的天气如何？”或“查询上海的气温”。

- **网络搜索**：
  输入格式示例：“2025年最新AI技术有哪些？”或“2024年诺贝尔物理学奖得主是谁？”。

##### **3.4 RAG知识库**
1. 菜单栏→知识库管理→加载知识文档，导入领域文档（PDF/TXT/Word）。
2. 启用“启用RAG增强”开关（RAG框架→勾选）。
3. 提问时AI将自动检索知识库并结合上下文回答（如“根据知识库内容，解释Transformer架构”）。


#### **4. 高级功能**
##### **4.1 情感模式**
- 点击“情感模式: 关闭”按钮切换为开启状态。
- 情感状态显示在顶部（如“情绪状态：感到兴奋，乐于助人”），AI将根据情感调整语气。

##### **4.2 对话记忆管理**
- **保存记忆**：菜单栏→记忆管理→保存记忆，或点击“保存记忆”按钮。
- **加载记忆**：双击文件列表中的记忆文件，或通过“加载记忆”对话框选择。
- **清除记忆**：点击“清除记忆”按钮，或菜单栏→记忆管理→清除记忆。


#### **5. 配置与故障排除**
##### **5.1 工具配置**
- **文件目录配置**：菜单栏→工具→配置文件读取，输入允许的目录路径（逗号分隔）。
- **API密钥配置**：
  - 天气查询：工具→配置天气查询，输入OpenWeatherMap密钥。
  - 网络搜索：工具→配置网络搜索，输入SerpAPI密钥并选择搜索引擎（Google/Bing/baidu）。

##### **5.2 常见问题**
- **问题1**：图像上传失败。
  - **解决**：确保图像格式为JPG/PNG，大小≤5MB；检查是否选择多模态模型（Qwen/QVQ-72B-Preview）。
  
- **问题2**：工具调用失败（如“文件不在允许的目录中”）。
  - **解决**：通过工具→配置文件读取，添加文件所在目录到允许列表。
  
- **问题3**：API响应错误（如“Invalid API key”）。
  - **解决**：检查`.env`文件中的API密钥是否正确，或通过工具配置界面重新输入。


#### **6. 技术支持**
- **联系方式**：在`IntelliFusion.py`中查看日志输出（`print`语句）定位问题。
- **错误反馈**：通过菜单栏→帮助→反馈问题，或在GitHub仓库提交Issue。


### **文档结构说明**
- **API文档**：聚焦接口参数、调用流程和异常处理，结合代码中的`INPUT_SCHEMA`和工具函数（如`read_file`）编写。
- **用户手册**：以功能操作为核心，覆盖基础使用、高级功能和配置方法，对应代码中的UI交互逻辑（`ChatApp._create_ui`）和业务流程（`send_message`）。
